{{define "content"}}
<p class="previous">&larr; <a href="/manage-channel-ops/">Previous</a></p>
<p class="next"><a href="/k8s-canary-release/">Next</a> &rarr;</p>
<h1>{{.Title}}</h1>
<p class="date">{{.DateTime.Format "2006-01-02"}} &sdot; 2 min read</p>
<p>Recently, I've been creating a lot of both internal and internet-facing LoadBalancer Services as this is a great way to expose your cluster to traffic. When doing this on AWS, unless specified otherwise, Kubernetes will automatically create a Classic Load Balancer and attach the relevant instances.</p>
<p>However, this got me thinking about duplicate ports on the same node assigned to different ELBs. How would Kubernetes handle this?</p>
<p>What actually happens when we set a Service type to <code>LoadBalancer</code> is Kubernetes will also expose a <code>NodePort</code> for each of the ports specified in the service.</p>
<p class="quote">...the Kubernetes master will allocate a port from a flag-configuw range (default: 30000-32767), and each Node will proxy that port (the same port number on every Node) into your Service...</p>
<p class="caption"><a href="https://kubernetes.io/docs/concepts/services-networking/service">https://kubernetes.io/docs/concepts/services-networking/service</a></p>
<p>For example, if I were to apply the following YAML:</p>
<pre class="yaml lines">
<code><span class="r">apiVersion:</span> v1</code>
<code><span class="r">kind:</span> Service</code>
<code><span class="r">metadata:</span></code>
<code> <span class="r">name:</span> my-service</code>
<code> <span class="r">labels:</span></code>
<code>   <span class="r">app:</span> my-service</code>
<code> <span class="r">annotations:</span></code>
<code>   <span class="r">service.beta.kubernetes.io/aws-load-balancer-ssl-cert:</span> [AWS ARN]</code>
<code>   <span class="r">service.beta.kubernetes.io/aws-load-balancer-ssl-ports:</span> <span class="y">"443"</span></code>
<code><span class="r">spec:</span></code>
<code> <span class="r">ports:</span></code>
<code> - <span class="r">name:</span> http</code>
<code>   <span class="r">protocol:</span> TCP</code>
<code>   <span class="r">port:</span> 80</code>
<code>   <span class="r">targetPort:</span> 6000</code>
<code> - <span class="r">name:</span> https</code>
<code>   <span class="r">protocol:</span> TCP</code>
<code>   <span class="r">port:</span> 443</code>
<code>   <span class="r">targetPort:</span> 6000</code>
<code> <span class="r">type:</span> LoadBalancer</code>
<code> <span class="r">selector:</span></code>
<code>   <span class="r">app:</span> my-service</code>
</pre>
<p>I would see something like this in the AWS Console:</p>
<a href="/images/aws-elb-listeners.png"><img src="/images/aws-elb-listeners.png" alt="AWS ELB Listeners" /></a>
<p class="caption">AWS Console: Load Balancer Listeners</p>
<p>Although it is possible to configure these ports manually by specifying <code>spec.ports[*].nodePort</code>, Kubernetes will automatically check the current in-use node ports and only assign one that is available.<p>
<hr />
<h3>Resources</h3>
<ul>
	<li><a href="https://docs.aws.amazon.com/elasticloadbalancing/latest/classic/elb-listener-config.html">Listeners for Your Classic Load Balancer</a></li>
	<li><a href="https://kubernetes.io/docs/concepts/services-networking/service/#type-loadbalancer">Kubernetes Service: LoadBalancer</a></li>
</ul>
{{end}}
