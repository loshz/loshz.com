<!DOCTYPE HTML>
<html lang="en">
<head>
	<meta charset="utf-8" />
	<meta name="description" content="A collection of articles focused around distributed systems, networking, observability and related topics.">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Kubernetes: Service ports</title>
	<link rel="stylesheet" href="../site.css" />
	<link rel="icon" type="image/png" href="../images/favicon.png" />
	<link rel="alternate" type="application/rss+xml" href="https://syscll.org/index.xml" title="Programming: thoughts and paradigms" />
</head>
<body>
	<div class="sidebar">
		<div class="top">
			<h1><a href="/">Programming: thoughts and paradigms</a></h1>
			<h2>A collection of articles focused around distributed systems, networking, observability and related topics.</h2>
			<ul>
				<li>GitHub <a href="https://github.com/syscll">syscll</a></li>
				<li>Twitter <a href="https://twitter.com/syscll">@syscll</a></li>
				<li>PGP <a href="public_key.asc">82E7 BCF2 EAB7 4CF0</a></li>
			</ul>
		</div>
		<div class="bottom">
			<p>Subscribe to the <a href="index.xml">RSS feed</a></p>
			<p>All content is licensed under <a href="https://creativecommons.org/licenses/by-sa/4.0/">Creative Commons Attribution-ShareAlike 4.0 International (CC BY-SA 4.0)</a></p>
		</div>
	</div>
	<div class="content">
		<div class="archive">
			<h2>Kubernetes: Service ports</h2>
			<p class="date">Apr 5, 2018</p>
			<p>Recently, I've been creating a lot of both internal and internet-facing LoadBalancer Services as this is a great way to expose your cluster to traffic. When doing this on AWS, unless specified otherwise, Kubernetes will automatically create a Classic Load Balancer and attach the relevant instances.</p>
			<p>However, this got me thinking about duplicate ports on the same node assigned to different ELBs. How would Kubernetes handle this?</p>
			<p>What actually happens when we set a Service type to <code>LoadBalancer</code> is Kubernetes will also expose a <code>NodePort</code> for each of the ports specified in the service.</p>
			<p class="quote">...the Kubernetes master will allocate a port from a flag-configured range (default: 30000-32767), and each Node will proxy that port (the same port number on every Node) into your Service...</p>
			<p class="caption"><a href="https://kubernetes.io/docs/concepts/services-networking/service">https://kubernetes.io/docs/concepts/services-networking/service</a></p>
			<p>For example, if I were to apply the following YAML:</p>
			<pre><code>apiVersion: <span class="red">v1</span>
kind: <span class="red">Service</span>
metadata:
  name: <span class="red">my-service</span>
  labels:
    app: <span class="red">my-service</span>
  annotations:
    service.beta.kubernetes.io/aws-load-balancer-ssl-cert: <span class="red">[AWS ARN]</span>
    service.beta.kubernetes.io/aws-load-balancer-ssl-ports: <span class="red">"443"</span>
spec:
  ports:
  - name: <span class="red">http</span>
    protocol: <span class="red">TCP</span>
    port: <span class="red">80</span>
    targetPort: <span class="red">6000</span>
  - name: <span class="red">https</span>
    protocol: <span class="red">TCP</span>
    port: <span class="red">443</span>
    targetPort: <span class="red">6000</span>
  type: <span class="red">LoadBalancer</span>
  selector:
    app: <span class="red">my-service</span></code></pre>
			<p>I would see something like this in the AWS Console:</p>
			<a href="../images/aws-elb-listeners.png"><img src="../images/aws-elb-listeners.png" alt="AWS ELB Listeners" /></a>
			<p class="caption">AWS Console: Load Balancer Listeners</p>
			<p>Although it is possible to configure these ports manually by specifying <code>spec.ports[*].nodePort</code>, Kubernetes will automatically check the current in-use node ports and only assign one that is available.<p>
			<hr />
			<h3>Resources</h3>
			<ul>
				<li><a href="https://docs.aws.amazon.com/elasticloadbalancing/latest/classic/elb-listener-config.html">Listeners for Your Classic Load Balancer</a></li>
				<li><a href="https://kubernetes.io/docs/concepts/services-networking/service/#type-loadbalancer">Kubernetes Service: LoadBalancer</a></li>
			</ul>
		</div>
	</div>
</body>
</html>
